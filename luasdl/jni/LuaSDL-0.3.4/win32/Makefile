# =============================================================================
#
# MinGW/msys makefile for LuaSDL
# PUBLIC DOMAIN 2007 Kein-Hong Man <khman@users.sf.net>
#
# =============================================================================
#
# DEVELOPED USING:
# * mingw 5.0.2 + msys 1.0.10
# * tolua++ 1.0.92
# * Lua 5.1.1 (DLL from official sources, "make mingw")
#
# =============================================================================

CP = cp
CC = gcc
EXE = .exe
TOLUA = tolua++

MYCFLAGS = -g -O2 -Wall
# asserts and tolua++ type checking ought to be left in, unless you really
# need every last bit of performance
#MYCFLAGS = -g -O2 -Wall -DNDEBUG -DTOLUA_RELEASE

MYLDFLAGS =
# strip the executable, don't do this if you are debugging
MYLDFLAGS = -s

# ======================================================================
# specifications and paths
# ======================================================================

LUA_INC = -I/usr/include -I../src
# dynamic linking
LUA_DLL = lua51.dll tolua++.dll
# static linking
#LUA_DLL = -llua -ltolua++

# relative to win32/
SRC_PATH = ../src
PKG_PATH = $(SRC_PATH)/binding
GEN_PATH = $(SRC_PATH)/autogen
# relative to src/binding
TOL_PATH = ../autogen

vpath %.h $(SRC_PATH) $(GEN_PATH)
vpath %.c $(SRC_PATH) $(GEN_PATH)

# suffix to identify autogenerated binding files, also hard coded in sources
BIND = _bind

SDL_LIB = -lSDL_image -lSDL_mixer -lSDL_net -lSDL_ttf

CFLAGS = $(MYCFLAGS) $(shell sdl-config --cflags) $(LUA_INC)
LDFLAGS = $(MYLDFLAGS) $(shell sdl-config --libs) $(SDL_LIB) $(LUA_DLL)

# ======================================================================
# names
# ======================================================================

LUASDL = luasdl
PROGRAMS = $(LUASDL)$(EXE)

# main binding
SDL_BIND = SDL
GEN_SDL = $(SDL_BIND)$(BIND)

# additional functionality
SDLLIB = sdllib

# sources for testing
TEST_LINK = test_linkage
TEST_BIND = test_binding

# bindings for testing
TEST_SDL = test_SDL
GEN_TEST_SDL = $(TEST_SDL)$(BIND)

# programs for testing
TEST_PROGS = 	$(TEST_LINK)$(EXE) \
		$(TEST_BIND)$(EXE)

# ======================================================================
# default
# ======================================================================

all: $(PROGRAMS)

# ======================================================================
# SDL binding
# ======================================================================

# tolua++ generation of interface code
$(GEN_PATH)/$(GEN_SDL).c: $(PKG_PATH)/$(SDL_BIND).pkg
	cd $(PKG_PATH) && \
	$(TOLUA) -H $(TOL_PATH)/$(GEN_SDL).h \
		 -o $(TOL_PATH)/$(GEN_SDL).c \
	         -n $(SDL_BIND) $(SDL_BIND).pkg

# main bulk of SDL, SDL_* interface, for tolua++ autogeneration
$(GEN_PATH)/$(GEN_SDL).c: \
	$(PKG_PATH)/$(SDL_BIND).pkg \
	$(SRC_PATH)/$(SDLLIB).h \
	\
	$(PKG_PATH)/SDL.h \
	$(PKG_PATH)/SDL_active.h \
	$(PKG_PATH)/SDL_audio.h \
	$(PKG_PATH)/SDL_cdrom.h \
	$(PKG_PATH)/SDL_config.h \
	$(PKG_PATH)/SDL_config_win32.h \
	$(PKG_PATH)/SDL_cpuinfo.h \
	$(PKG_PATH)/SDL_endian.h \
	$(PKG_PATH)/SDL_error.h \
	$(PKG_PATH)/SDL_events.h \
	$(PKG_PATH)/SDL_joystick.h \
	$(PKG_PATH)/SDL_keyboard.h \
	$(PKG_PATH)/SDL_keysym.h \
	$(PKG_PATH)/SDL_mouse.h \
	$(PKG_PATH)/SDL_platform.h \
	$(PKG_PATH)/SDL_quit.h \
	$(PKG_PATH)/SDL_rwops.h \
	$(PKG_PATH)/SDL_stdinc.h \
	$(PKG_PATH)/SDL_timer.h \
	$(PKG_PATH)/SDL_version.h \
	$(PKG_PATH)/SDL_video.h \
	\
	$(PKG_PATH)/SDL_image.h \
	\
	$(PKG_PATH)/SDL_mixer.h \
	\
	$(PKG_PATH)/SDL_net.h \
	\
	$(PKG_PATH)/SDL_ttf.h

# wraps around tolua++ code and adds additional functionality
$(SRC_PATH)/$(SDLLIB).c: $(SRC_PATH)/$(SDLLIB).h \
			 $(GEN_PATH)/$(GEN_SDL).c \
			 $(SRC_PATH)/DejaVu-Sans-Mono-13.c

# needed object files
SDLLIB_OBJS = $(SDLLIB).o \
	      $(GEN_SDL).o

# ======================================================================
# main program
# ======================================================================

# place your custom libraries here and initialize from luasdl.c
MYSDLLIBS = luasdlrc.o

luasdlrc.o: luasdl.rc luasdl.ico
	windres $< $@

$(SRC_PATH)/$(LUASDL).c: $(SRC_PATH)/$(SDLLIB).h \
			 $(SRC_PATH)/$(SDLLIB).c \
			 luasdl.rc

$(LUASDL)$(EXE): $(LUASDL).o $(MYSDLLIBS) $(SDLLIB_OBJS)
	$(CC) -o $@ $(LUASDL).o $(SDLLIB_OBJS) $(MYSDLLIBS) $(LDFLAGS)

# ======================================================================
# test programs
# - these tests need compilation, LuaSDL tests in Lua are in tests/
# ======================================================================

test: $(TEST_PROGS)

# ======================================================================

$(TEST_LINK)$(EXE): $(TEST_LINK).o
	$(CC) -o $@ $^ $(LDFLAGS)

# ======================================================================

$(GEN_PATH)/$(GEN_TEST_SDL).c: $(PKG_PATH)/$(TEST_SDL).pkg
	cd $(PKG_PATH) && \
	$(TOLUA) -H $(TOL_PATH)/$(GEN_TEST_SDL).h \
		 -o $(TOL_PATH)/$(GEN_TEST_SDL).c \
	         -n $(TEST_SDL) $(TEST_SDL).pkg

$(SRC_PATH)/$(TEST_BIND).c: $(GEN_PATH)/$(GEN_TEST_SDL).c

test_binding.lua: $(SRC_PATH)/test_binding.lua
	$(CP) $< $@

$(TEST_BIND)$(EXE): $(TEST_BIND).o $(GEN_TEST_SDL).o test_binding.lua
	$(CC) -o $@ $(TEST_BIND).o $(GEN_TEST_SDL).o $(LDFLAGS)

# ======================================================================
# maintenance
# ======================================================================

wipe:	clean
	rm -f $(GEN_PATH)/*.h $(GEN_PATH)/*.c

clean:
	rm -f $(PROGRAMS) $(TEST_PROGS) *.o
	rm -f stdout.txt stderr.txt

.PHONY: all test wipe clean

# ======================================================================
# (end of Makefile)
